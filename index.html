<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Chat Room</title>
  <link rel="stylesheet" href="style.css">

  <script type="module">
    // ====== SIMPLE SITE PASSWORD ======
    const SITE_PASSWORD = "chatpass"; // change this to your password
    let entered = false;

    while (!entered) {
      const p = prompt("Enter password to join chat:");
      if (p === null) {
        // User cancelled – reload to keep asking
        location.reload();
      } else if (p === SITE_PASSWORD) {
        entered = true;
      }
    }

    // ====== FIREBASE IMPORTS (FROM CDN) ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getDatabase, ref, push, onChildAdded, query, limitToLast 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ====== YOUR FIREBASE CONFIG (YOUR REAL VALUES) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBfiHEgGZSgbVfR1ghKsKBj3iGnaBHWM9s",
      authDomain: "thechat-f9c94.firebaseapp.com",
      databaseURL: "https://thechat-f9c94-default-rtdb.firebaseio.com",
      projectId: "thechat-f9c94",
      storageBucket: "thechat-f9c94.firebasestorage.app",
      messagingSenderId: "765122820358",
      appId: "1:765122820358:web:a7b97edbe27733e096c687"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ====== SEND MESSAGE FUNCTION ======
    window.chatApp = {
      sendMessage: () => {
        const nameInput = document.getElementById("name");
        const msgInput = document.getElementById("message");
        const name = nameInput.value.trim();
        const text = msgInput.value.trim();

        if (!name) {
          alert("Please enter your name.");
          return;
        }
        if (!text) {
          return;
        }

        push(ref(db, "messages"), {
          name: name,
          message: text,
          createdAt: Date.now()
        });

        msgInput.value = "";
        msgInput.focus();
      }
    };

    // ====== LISTEN FOR NEW MESSAGES ======
    window.addEventListener("DOMContentLoaded", () => {
      const chatContainer = document.getElementById("chat");
      const messagesRef = query(ref(db, "messages"), limitToLast(100));

      onChildAdded(messagesRef, snapshot => {
        const data = snapshot.val();
        const name = data.name || "Anon";
        const message = data.message || "";
        const time = data.createdAt ? new Date(data.createdAt) : null;

        const row = document.createElement("div");
        row.className = "message-row";

        const meta = time 
          ? `${name} · ${time.toLocaleTimeString()}`
          : name;

        row.innerHTML = `
          <div class="message-meta">${meta}</div>
          <div class="message-text">${escapeHtml(message)}</div>
        `;

        chatContainer.appendChild(row);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }
    });
  </script>
</head>
<body>
  <div class="chat-wrapper">
    <h1>The Chat Room</h1>
    <div class="controls">
      <input id="name" type="text" placeholder="Your name">
      <input id="message" type="text" placeholder="Type a message and press Send">
      <button onclick="chatApp.sendMessage()">Send</button>
    </div>
    <div id="chat" class="chat-box"></div>
    <div class="footer">
      <a href="admin.html" target="_blank">Admin</a>
    </div>
  </div>
</body>
</html>
